---
title: "Generalized Linear Mixed Models for Moderator Analyses"
date: "2025-10-07"
output:
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    toc_depth: 4
    number_sections: true
    code_folding: hide
  word_document:
    toc: true
    toc_depth: 4
  pdf_document:
    toc: true
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = TRUE, message = FALSE, cache = FALSE)

# Set the root directory for the entire document (recommended way)
knitr::opts_knit$set(root.dir = dirname(rstudioapi::getActiveDocumentContext()$path))
```

# Preparation

```{r load-packages}
library(tidyverse)
library(lme4)
library(broom.mixed)
library(forcats)
library(gt)
library(knitr)
library(dplyr)
library(purrr)
library(stringr)
library(tidyr)
library(flextable)
library(officer)
```

## Load Data

```{r load-data}
# load data
df_moderation <- read.csv2("../pre-processing/output/data_for_moderation_analyses.csv", dec = ".")

# calculate Sample_Size_100
df_moderation <- df_moderation %>%
  mutate(Sample_Size_100 = Sample_Size / 100)

# Display the first rows to check the data
head(df_moderation)
```

## Descriptive Statistics

We provide basic descriptive statistics of the included studies, without excluding any data due to missingness.

```{r descriptives}
# Calculate descriptives
total_number_of_samples <- nrow(df_moderation)
total_sample_size <- sum(df_moderation$Sample_Size, na.rm = TRUE)

# Create a summary table
summary_table <- data.frame(
  Description = c("Number of samples / cohorts", "Total sample size (sum of available Sample_Size)"),
  Value = format(c(total_number_of_samples, total_sample_size), big.mark = ",")
)

# Display as a table
knitr::kable(summary_table, caption = "Descriptive Statistics of the Dataset")
```

# Substantive Models
## Setup
```{r substantive-mods-setup-functions}
background_vars <- c(
  "Mean_age", "Developmental_age","Percentage_women", "Percentage_minority", "Percentage_partner", "High_education", "Location", "Location_US"
  )

trauma_vars <- c(
  "Discrete", "Health_First", "Trauma_type", "Military", "Occupational_trauma", "Trauma_exposure"
  )

method_vars <- c(
  "Sample_Size_100", "Grolts", "Entropy", "Scale_moderator", "Diagnostic_DSM", "Trajectory_analysis", "TP_assessments", "N_trajectories",
  "Trauma_TP1", "TP1_TPX", "Trauma_TPX"
  )

.ctrl <- ctrl # Use the pre-defined 'ctrl'

# Check if a variable is categorical using the pre-defined list from 'mods-setup-functions'
is_categorical <- function(v) {
  v %in% sapply(cat_vars, `[[`, "var")
}

# get the p-value column name
.pcol <- function(coef_mat) {
  hits <- intersect(colnames(coef_mat), c("Pr(>|z|)", "Pr(>|t|)", "Pr(>|Chisq|)"))
  if (length(hits)) hits[1] else NA_character_
}

# Find keep/ref settings for a categorical variable from cat_vars list
get_cat_specs <- function(var) {
  specs <- Filter(function(x) x$var == var, cat_vars)
  if (length(specs) == 1) return(specs[[1]]) else return(NULL)
}

# Fit a categorical moderator (using get_cat_specs)
fit_cat <- function(data, var, success_col = "Low_n", denom_col = "Sample_Size") {
  specs <- get_cat_specs(var)
  if (is.null(specs)) return(tibble::tibble())

  d <- data %>%
    dplyr::filter(!is.na(.data[[var]])) %>%
    { if (!is.null(specs$keep)) dplyr::filter(., .data[[var]] %in% specs$keep) else . } %>%
    add_binom_cols(success_col, denom_col) %>%
    dplyr::mutate(
      !!rlang::sym(var) := forcats::as_factor(.data[[var]]),
      !!rlang::sym(var) := if (!is.null(specs$ref) && specs$ref %in% levels(.data[[var]])) {
        forcats::fct_relevel(.data[[var]], specs$ref)
      } else {
        forcats::fct_drop(.data[[var]])
      }
    )

  if (nlevels(d[[var]]) < 2) return(tibble::tibble())

  fml <- stats::as.formula(paste0("cbind(Success, Failure) ~ ", var, " + (1 | Study)"))
  m <- lme4::glmer(fml, data = d, family = binomial, control = .ctrl)

  fe <- lme4::fixef(m)
  b0 <- unname(fe["(Intercept)"])
  lvls <- levels(d[[var]])

  add <- sapply(lvls, function(L) { nm <- paste0(var, L); if (nm %in% names(fe)) fe[[nm]] else 0 })

  s <- summary(m)$coefficients
  pcol <- .pcol(s)
  pvals <- sapply(lvls, function(L) {
    nm <- paste0(var, L)
    if (!is.na(pcol) && nm %in% rownames(s)) unname(s[nm, pcol]) else NA_real_
  })

  p <- plogis(b0 + add)
  p_ref <- p[1]

  tibble::tibble(
    trajectory      = sub("_n$", "", success_col),
    moderator       = var,
    n               = stats::nobs(m),
    ref_level       = lvls[1],
    level           = lvls,
    prevalence_pct  = 100 * p,
    diff_vs_ref_pp  = 100 * (p - p_ref),
    p_value         = pvals
  )
}

# Run a set of variables on a trajectory dataset
run_group <- function(df_traj, vars, success_col = "Low_n", denom_col = "Sample_Size") {
  is_cat <- vapply(vars, is_categorical, logical(1))
  cont_vars_group <- vars[!is_cat]
  cat_vars_group  <- vars[is_cat]

  res_cont <- if (length(cont_vars_group)) purrr::map_dfr(cont_vars_group, ~fit_cont(df_traj, .x, success_col, denom_col)) else tibble::tibble()
  res_cat  <- if (length(cat_vars_group))  purrr::map_dfr(cat_vars_group, ~fit_cat (df_traj, .x, success_col, denom_col)) else tibble::tibble()

  list(cont = res_cont, cat = res_cat)
}


# Unified table column definitions
UNIFIED_COLS <- c(
  "Predictor", "k_shared",
  "Ref_Prevalence_Cont", "Delta_Marginal_Cont", "p_value_shared",
  "Ref_Name_Cat", "Ref_Prevalence_Cat", "Comp_Name_Cat", "Comp_Prevalence_Cat", "Delta_Marginal_Cat"
)

.empty_unified_tbl <- function() {
  tibble::tibble(
    Predictor          = character(),
    k_shared           = integer(),
    Ref_Prevalence_Cont  = character(),
    Delta_Marginal_Cont  = character(),
    p_value_shared     = character(),
    Ref_Name_Cat       = character(),
    Ref_Prevalence_Cat   = character(),
    Comp_Name_Cat      = character(),
    Comp_Prevalence_Cat  = character(),
    Delta_Marginal_Cat   = character()
  )
}

.na_label <- "-"

# make_group_table function
make_group_table <- function(group_res, title, na_label = .na_label) {

  # --- A. Continuous ---
  cont_tbl <- if (!is.null(group_res$cont) && nrow(group_res$cont) > 0) {
    group_res$cont %>%
      dplyr::mutate(
        Predictor         = dplyr::recode(predictor, !!!mod_labels, .default = predictor),
        k_shared          = as.integer(Samples),
        Ref_Prevalence_Cont = sprintf("%.2f%%", prevalence_at_0_pct),
        Delta_Marginal_Cont = paste0(round(marginal_delta_pp_per_unit, 2)),
        p_value_shared      = paste0(fmt_p(p_value), ifelse(is.na(p_value), "", paste0(" ", sig(p_value)))),
        Ref_Name_Cat        = na_label,
        Ref_Prevalence_Cat  = na_label,
        Comp_Name_Cat     = na_label,
        Comp_Prevalence_Cat = na_label,
        Delta_Marginal_Cat  = na_label
      ) %>%
      dplyr::select(dplyr::all_of(UNIFIED_COLS))
  } else {
    .empty_unified_tbl()
  }

  # --- B. Categorical ---
  cat_tbl <- if (!is.null(group_res$cat) && nrow(group_res$cat) > 0) {
    ref_prev <- group_res$cat %>%
      dplyr::filter(level == ref_level) %>%
      dplyr::select(moderator, ref_level, ref_prev = prevalence_pct)

    group_res$cat %>%
      dplyr::filter(level != ref_level) %>%
      dplyr::left_join(ref_prev, by = c("moderator","ref_level")) %>%
      dplyr::left_join(lvl_map, by = c("moderator","ref_level" = "orig")) %>%
      dplyr::rename(pretty_ref = pretty) %>%
      dplyr::left_join(lvl_map, by = c("moderator","level" = "orig")) %>%
      dplyr::rename(pretty_cmp = pretty) %>%
      dplyr::mutate(
        Predictor         = dplyr::recode(moderator, !!!mod_labels, .default = moderator),
        k_shared          = as.integer(n),
        Ref_Prevalence_Cont = na_label,
        Delta_Marginal_Cont = na_label,
        Ref_Name_Cat      = dplyr::coalesce(pretty_ref, ref_level),
        Ref_Prevalence_Cat  = sprintf("%.1f%%", ref_prev),
        Comp_Name_Cat     = dplyr::coalesce(pretty_cmp, level),
        Comp_Prevalence_Cat = sprintf("%.1f%%", prevalence_pct),
        Delta_Marginal_Cat  = sprintf("%.2f", diff_vs_ref_pp),
        p_value_shared    = paste0(fmt_p(p_value), ifelse(is.na(p_value), "", paste0(" ", sig(p_value))))
      ) %>%
      dplyr::select(dplyr::all_of(UNIFIED_COLS))
  } else {
    .empty_unified_tbl()
  }


  # ---- C. Bind + render ----
  out <- dplyr::bind_rows(cont_tbl, cat_tbl)

  gt::gt(out) %>%
    gt::tab_header(title = enc2utf8(title)) %>%
    gt::cols_label(
      Predictor = gt::md("**Predictor**"),
      k_shared = gt::md("k"),
      p_value_shared = gt::md("p-value"),
      Ref_Prevalence_Cont = gt::md("Relative<br>prevalence at 0%"),
      Delta_Marginal_Cont = gt::md("Marginal Î”"), 
      Ref_Name_Cat = gt::md("Reference (Name)"),
      Ref_Prevalence_Cat = gt::md("Reference Prevalence"),
      Comp_Name_Cat = gt::md("Comparison (Name)"),
      Comp_Prevalence_Cat = gt::md("Comparison Prevalence"),
      Delta_Marginal_Cat = gt::md("Marginal Î”")
    ) %>%
    gt::tab_spanner(
      label = gt::md("**Continuous Moderators**"),
      columns = c(Ref_Prevalence_Cont, Delta_Marginal_Cont),
      id = "cont_group"
    ) %>%
    gt::tab_spanner(
      label = gt::md("**Categorical Moderators**"),
      columns = c(Ref_Name_Cat, Ref_Prevalence_Cat, Comp_Name_Cat, Comp_Prevalence_Cat, Delta_Marginal_Cat),
      id = "cat_group"
    ) %>%
    gt::cols_align("left",  columns = Predictor) %>%
    gt::cols_align("center", columns = -Predictor) %>%
    gt::cols_width(Predictor ~ gt::px(180), k_shared ~ gt::px(50), p_value_shared ~ gt::px(70)) %>%
    gt::tab_style(
      style = gt::cell_text(weight = "bold"),
      locations = gt::cells_column_labels(columns = gt::everything())
    ) %>%
    gt::tab_options(
      table.width = gt::pct(100),
      data_row.padding = gt::px(4),
      column_labels.padding = gt::px(6),
      table.font.size = gt::px(13),
      table.font.names = "Times New Roman"
    )
}
```

## ðŸš€ Low Symptom Trajectory

```{r Low-mods-fitting}
# Run the three groups for this trajectory
bg_res_Low <- run_group(df_Low, success_col = "Low_n", denom_col = "Sample_Size", vars = background_vars)
tr_res_Low <- run_group(df_Low, success_col = "Low_n", denom_col = "Sample_Size", vars = trauma_vars)
md_res_Low <- run_group(df_Low, success_col = "Low_n", denom_col = "Sample_Size", vars = method_vars)

all_vars <- c(background_vars, trauma_vars, method_vars)
all_Low_res <- run_group(df_Low, success_col = "Low_n", denom_col = "Sample_Size", vars = all_vars)
```

```{r Low-mods-tables}
make_group_table(bg_res_Low, "Low Symptom Trajectory: Socio-Demographic Moderators")
make_group_table(tr_res_Low, "Low Symptom Trajectory: Trauma-Related Moderators")
make_group_table(md_res_Low, "Low Symptom Trajectory: Methodological Moderators")
make_group_table(all_Low_res, "Low Symptom Trajectory: All Moderators")
```
## âš ï¸ Increasing Symptom Trajectory

```{r Increasing-mods-fitting}
# Run the three groups for this trajectory
bg_res_Increasing <- run_group(df_Increasing, success_col = "Increasing_n", denom_col = "Sample_Size", vars = background_vars)
tr_res_Increasing <- run_group(df_Increasing, success_col = "Increasing_n", denom_col = "Sample_Size", vars = trauma_vars)
md_res_Increasing <- run_group(df_Increasing, success_col = "Increasing_n", denom_col = "Sample_Size", vars = method_vars)

all_vars <- c(background_vars, trauma_vars, method_vars)
all_Increasing_res <- run_group(df_Increasing, success_col = "Increasing_n", denom_col = "Sample_Size", vars = all_vars)
```

```{r Increasing-mods-tables}
make_group_table(bg_res_Increasing, "Increasing Symptom Trajectory: Socio-Demographic Moderators")
make_group_table(tr_res_Increasing, "Increasing Symptom Trajectory: Trauma-Related Moderators")
make_group_table(md_res_Increasing, "Increasing Symptom Trajectory: Methodological Moderators")
make_group_table(all_Increasing_res, "Increasing Symptom Trajectory: All Moderators")
```
## ðŸŒ¿ Decreasing Symptom Trajectory

```{r Decreasing-mods-fitting}
# Run the three groups for this trajectory
bg_res_Decreasing <- run_group(df_Decreasing, success_col = "Decreasing_n", denom_col = "Sample_Size", vars = background_vars)
tr_res_Decreasing <- run_group(df_Decreasing, success_col = "Decreasing_n", denom_col = "Sample_Size", vars = trauma_vars)
md_res_Decreasing <- run_group(df_Decreasing, success_col = "Decreasing_n", denom_col = "Sample_Size", vars = method_vars)

all_vars <- c(background_vars, trauma_vars, method_vars)
all_Decreasing_res <- run_group(df_Decreasing, success_col = "Decreasing_n", denom_col = "Sample_Size", vars = all_vars)
```

```{r Decreasing-mods-tables}
make_group_table(bg_res_Decreasing, "Decreasing Symptom Trajectory: Socio-Demographic Moderators")
make_group_table(tr_res_Decreasing, "Decreasing Symptom Trajectory: Trauma-Related Moderators")
make_group_table(md_res_Decreasing, "Decreasing Symptom Trajectory: Methodological Moderators")
make_group_table(all_Decreasing_res, "Decreasing Symptom Trajectory: All Moderators")
```
## ðŸ©¸ High Symptom Trajectory

```{r High-mods-fitting}
# Run the three groups for this trajectory
bg_res_High <- run_group(df_High, success_col = "High_n", denom_col = "Sample_Size", vars = background_vars)
tr_res_High <- run_group(df_High, success_col = "High_n", denom_col = "Sample_Size", vars = trauma_vars)
md_res_High <- run_group(df_High, success_col = "High_n", denom_col = "Sample_Size", vars = method_vars)

all_vars <- c(background_vars, trauma_vars, method_vars)
all_High_res <- run_group(df_High, success_col = "High_n", denom_col = "Sample_Size", vars = all_vars)
```

```{r High-mods-tables}
make_group_table(bg_res_High, "High Symptom Trajectory: Socio-Demographic Moderators")
make_group_table(tr_res_High, "High Symptom Trajectory: Trauma-Related Moderators")
make_group_table(md_res_High, "High Symptom Trajectory: Methodological Moderators")
make_group_table(all_High_res, "High Symptom Trajectory: All Moderators")
```

## ðŸŒ— Moderate Symptom Trajectory

```{r Moderate-mods-fitting}
# Run the three groups for this trajectory
bg_res_Moderate <- run_group(df_Moderate, success_col = "Moderate_n", denom_col = "Sample_Size", vars = background_vars)
tr_res_Moderate <- run_group(df_Moderate, success_col = "Moderate_n", denom_col = "Sample_Size", vars = trauma_vars)
md_res_Moderate <- run_group(df_Moderate, success_col = "Moderate_n", denom_col = "Sample_Size", vars = method_vars)

all_vars <- c(background_vars, trauma_vars, method_vars)
all_Moderate_res <- run_group(df_Moderate, success_col = "Moderate_n", denom_col = "Sample_Size", vars = all_vars)
```

```{r Moderate-mods-tables}
make_group_table(bg_res_Moderate, "Moderate Symptom Trajectory: Socio-Demographic Moderators")
make_group_table(tr_res_Moderate, "Moderate Symptom Trajectory: Trauma-Related Moderators")
make_group_table(md_res_Moderate, "Moderate Symptom Trajectory: Methodological Moderators")
make_group_table(all_Moderate_res, "Moderate Symptom Trajectory: All Moderators")
```

# Tables for Paper
## Continuous Moderators Summary Table

```{r cont-mods-summary-table}
# enforce trajectory order
traj_order <- c("Low","Decreasing","Increasing","High","Moderate")

#define trajectory fits
fits_by_traj <- list(
  Low        = fits_cont_Low,
  Decreasing = fits_cont_Decreasing,
  Increasing = fits_cont_Increasing,
  High       = fits_cont_High,
  Moderate   = fits_cont_Moderate
)

# build combined table
tbl_all <- bind_rows(fits_by_traj, .id = "Trajectory") %>%
  mutate(
    Trajectory = factor(Trajectory, levels = traj_order),
    Predictor = dplyr::recode(predictor, !!!mod_labels, .default = predictor),
    Predictor = factor(Predictor, levels = mod_levels),
    `Prevalence (0%)` = sprintf("%.1f%%", prevalence_at_0_pct),
    !!delta_col := marginal_delta_pp_per_unit,
    `P-value` = paste0(fmt_p(p_value), ifelse(is.na(p_value), "", paste0(" ", sig(p_value)))),
    Slope = slope
  ) %>%
  select(Trajectory, Predictor, Samples, `Prevalence (0%)`, Slope, dplyr::all_of(delta_col), `P-value`) %>%
  arrange(Trajectory, Predictor)

# ensure UTF-8
tbl_all_utf8 <- tbl_all
names(tbl_all_utf8) <- enc2utf8(names(tbl_all_utf8))
tbl_all_utf8 <- mutate(tbl_all_utf8, across(where(is.character), enc2utf8))

# render one big table, grouped by Trajectory
tbl_all_utf8 %>%
  gt(groupname_col = "Trajectory") %>%
  cols_width(Predictor ~ px(220)) %>%
  cols_align(align = "center", columns = -Predictor) %>%
  cols_align(align = "left",   columns = Predictor) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = list(
      cells_column_labels(columns = everything()),    # bold headers
      cells_row_groups(groups = everything())         # bold group labels
    )
  ) %>%
  tab_options(table.width = pct(100)) %>%
  opt_table_font(font = "Times New Roman") 

# export to word
df <- tbl_all_utf8

ft <- flextable(df)
ft <- width(ft, j = "Predictor", width = 2.2)
ft <- align(ft, j = setdiff(names(df), "Predictor"), align = "center", part = "all")
ft <- align(ft, j = "Predictor", align = "left", part = "all")
ft <- bold(ft, part = "header")
ft <- font(ft, fontname = "Times New Roman", part = "all")
ft <- autofit(ft)

doc <- read_docx()
doc <- body_add_flextable(doc, ft)
doc <- body_end_section_landscape(doc)
print(doc, target = "Continuous_Moderator_Table.docx")
```

## Categorical Moderators Summary Table

```{r cat-mods-summary-table}
# enforce trajectory order
traj_order <- c("Low","Decreasing","Increasing","High","Moderate")

# find and combine all 'fits_cat_*' data frames
fit_names <- ls(pattern = "^fits_cat_")

if (length(fit_names) == 0) {
  knitr::kable(data.frame(Note = "No categorical moderator results found."))
} else {
  all_fits_cat <- mget(fit_names) %>%
    list_rbind(names_to = "traj") %>%
    mutate(traj = str_remove(traj, "fits_cat_"),
         traj = factor(traj, levels = traj_order))

  # Prepare the final long table data for gt
  long_table_data <- all_fits_cat %>%
    # Add reference prevalence to each row for comparison
    left_join(
      y  = filter(., level == ref_level) %>% select(traj, moderator, ref_prev = prevalence_pct),
      by = c("traj", "moderator")
    ) %>%
    filter(level != ref_level) %>%
    # Create and format the final columns
    mutate(
      Predictor               = recode(moderator, !!!mod_labels, .default = moderator),
      `Reference (Name)`      = coalesce(lvl_map$pretty[match(ref_level, lvl_map$orig)], ref_level),
      `Comparison (Name)`     = coalesce(lvl_map$pretty[match(level, lvl_map$orig)], level),
      `Samples (k)`           = n,
      `Reference Prevalence`  = sprintf("%.1f%%", ref_prev),
      `Comparison Prevalence` = sprintf("%.1f%%", prevalence_pct),
      !!delta_col      := round(diff_vs_ref_pp, 2),
      `p-value`               = paste0(fmt_p(p_value), " ", sig(p_value))
    ) %>%
    # Select and order the final columns
    select(
      traj, # This column is kept for grouping
      Predictor,
      `Samples (k)`,
      `Reference (Name)`,
      `Reference Prevalence`,
      `Comparison (Name)`,
      `Comparison Prevalence`,
      !!delta_col,
      `p-value`
    ) %>%
    arrange(traj, Predictor, `Comparison (Name)`)

  # Build the final table, grouped by trajectory
  long_table_data %>%
    gt(groupname_col = "traj") %>%
    # Apply styling
    cols_width(Predictor ~ px(220)) %>%
    cols_align(align = "center", columns = where(is.numeric) | where(is.character)) %>%
    cols_align(align = "left", columns = c(Predictor, `Reference (Name)`, `Comparison (Name)`)) %>%
    tab_style(
      style = cell_text(weight = "bold"),
      locations = list(
      cells_column_labels(columns = everything()),    # bold headers
      cells_row_groups(groups = everything())         # bold group labels
    )
     ) %>%
  tab_options(table.width = pct(100)) %>%
  opt_table_font(font = "Times New Roman") 
}

# export to word
df2 <-  long_table_data

ft <- flextable(df2)
ft <- width(ft, j = "Predictor", width = 2.2)
ft <- align(ft, j = setdiff(names(df2), "Predictor"), align = "center", part = "all")
ft <- align(ft, j = "Predictor", align = "left", part = "all")
ft <- bold(ft, part = "header")
ft <- font(ft, fontname = "Times New Roman", part = "all")
ft <- autofit(ft)

doc <- read_docx()
doc <- body_add_flextable(doc, ft)
doc <- body_end_section_landscape(doc)
print(doc, target = "Categorical_Moderator_Table.docx")
```
---


